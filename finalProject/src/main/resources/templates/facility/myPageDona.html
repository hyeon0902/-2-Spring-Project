<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>시설마이페이지</title>
 <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
 <style>
 .btn:hover,
 .btn:focus {
    background-color: #689f38; 
    color: white;
 }
</style>
</head>
<body>

   <section layout:fragment="content"  class="d-flex">
   <div class="row" >
       <div class="side col-2" th:insert="~{facility/sidebar::side}"></div>
         <div class="col-md-10 main-content">
                      

                <div class="row hotel_booking_table">
                
                        <div class="row" style="text-align:center;">
                       
                           
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                     <p style="color:black; font-size:20px">기부제목</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                      <p style="color:black; font-size:20px">모집기간</p>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">모집금액</p>
                                       
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">달성률</p>
                                       
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">기간연장</p>
                                       
                                    </div>
                                </div>
                        
                          
                  
                 
                            
                            <th:block th:each="dona0:${donaList0}">
                            
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                     <p><a th:href="@{/donaDetail(id=${dona0.donId}, facId=${dona0.facId})}" th:text="${dona0.title}"></a></p>
                                    <input type="hidden" id="did" th:value="${dona0.donId}"> 
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                      <p id="endP" th:text="${#dates.format(dona0.recPeriod,'yyyy-MM-dd')} +'~'+${#dates.format(dona0.endPeriod,'yyyy-MM-dd')}"></p>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p th:text="${#numbers.formatInteger(dona0.targetOk,3,'COMMA')+'원'}"></p>
                                     
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p th:text="${dona0.donationRatio}+'%'"></p>
                                     
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                     <!-- endPeriod가 하루 전이면 버튼 활성화, 그렇지 않으면 비활성화 -->
                                       
                                      <a href="#" th:onclick="openExtModal([[${dona0.donId}]])"><button class="btn" >연장하기</button></a>
                                    </div>
                                </div>
                                </th:block>   
                       
                </div>
                </div>
                
                <br>
                <br>
                <br>
                <br>
                
                <div class="row hotel_booking_table">
                
                    
                        <div class="boking_table">
                       
                         <div class="row" style="text-align:center;">
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                     <p style="color:black; font-size:20px">기부제목</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                      <p style="color:black; font-size:20px">모집기간</p>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">모집금액</p>
                                       
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">달성률</p>
                                       
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">후기작성</p>
                                       
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="book_tabel_item">
                                       <p style="color:black; font-size:20px">영수증등록</p>
                                       
                                    </div>
                                </div>
                        
                            <th:block th:each="dona:${donaList1}">
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                     <p><a th:href="@{/donaDetail(id=${dona.donId}, facId=${dona.facId})}" th:text="${dona.title}"></a></p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="book_tabel_item">
                                      <p th:text="${#dates.format(dona.recPeriod,'yyyy-MM-dd')} +'~'+${#dates.format(dona.endPeriod,'yyyy-MM-dd')}"></p>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p th:text="${#numbers.formatInteger(dona.targetOk,3,'COMMA')+'원'}"></p>
                                     
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="book_tabel_item">
                                       <p th:text="${dona.donationRatio}+'%'"></p>
                                     
                                    </div>
                                </div>
                            
                           
                         <div class="col-md-1">
                                    <div class="book_tabel_item">
                                     <!-- endPeriod가 하루 전이면 버튼 활성화, 그렇지 않으면 비활성화 -->
                                        <button class="btn" onclick="openReviewForm(this)" th:attr="data-donId=${dona.donId}, data-facId=${dona.facId}, data-hasrev=${dona.hasreview}">후기작성</button>


                                      <!--  <a class="book_now_btn button_hover" style="font-size: 14px; padding: 8px 12px;" th:attr="data-donId=${dona.donId}, data-facId=${dona.facId}" th:onclick="openReviewForm(this)">후기</a> -->

                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="book_tabel_item">
                                     <!-- endPeriod가 하루 전이면 버튼 활성화, 그렇지 않으면 비활성화 -->
                                        <button class="btn" onclick="openReceiptModal(this)" th:attr="data-donId=${dona.donId}, data-facId=${dona.facId}">영수증</button>

                                        <!-- <a class="book_now_btn button_hover" style="font-size: 14px; padding: 8px 12px;" th:attr="data-donId=${dona.donId}, data-facId=${dona.facId}" th:onclick="openReceiptModal(this)">영수증</a> -->
                   
                                    </div>
                                </div>
                    </th:block> 
                </div>
            </div>
            </div>
          </div>  
            
            
     <div class="modal fade" id="extendDeadlineModal" tabindex="-1" role="dialog" aria-labelledby="extendDeadlineModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extendDeadlineModalLabel"> 모금 기한 연장하기 </h5> 
                </div>
                <div class="modal-body">
                    <p> 모금액이 목표모금액보다 적기 때문에 2주 이내로 기한을 연장할 수 있습니다. (1회 한정)</p>
                    
                    <!-- date 입력란 추가 -->
                    <div class="form-group">
                        <label for="newDeadline">연장 기한 선택:</label>
                        <input type="date" class="form-control" id="newDeadline" name="newDeadline" required>
                    </div>
                          <!-- 숨겨진 입력 필드 추가 -->
                         <input type="hidden" id="donIdForExtension">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="extendDeadline()"> 연장하기 </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- 영수증 첨부 모달 -->
<div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">영수증 첨부</h5>
            </div>
            <div class="modal-body">
                <!-- 파일 첨부 양식 -->
                <form id="receiptForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="receiptFile">영수증 파일 선택:</label>
                        <input type="file" class="form-control-file" id="uploadFiles" name="uploadFiles" accept=".pdf, .jpg, .png" required>
                    </div>
                    <!-- 추가: 숨겨진 입력 필드 -->
                    <input type="hidden" id="donIdForReceipt">
                    <input type="hidden" id="facIdForReceipt">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitReceipt()">제출하기</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>

<!-- 영수증 첨부 성공 메시지 모달 -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">영수증 등록 성공</h5>
            </div>
            <div class="modal-body">
                <p>영수증이 성공적으로 등록되었습니다!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>

   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
                
<script th:inline="javascript">

function openExtModal(donId){
	console.log("모달창열리고", donId);
	// 모달에 donId 저장하기
    document.getElementById("donIdForExtension").value = donId;
	
	$("#extendDeadlineModal").modal("show");
	
	$(".btn-secondary").click(function () {
	    $("#extendDeadlineModal").modal("hide");
	});
}


// 기한 연장 처리 함수
function extendDeadline() {
    // 선택된 기한 값 가져오기
    let newDeadlineValue = document.getElementById("newDeadline").value;
    //	console.log("새로운 기한:", newDeadlineValue);
    	
    let donIdVal = document.getElementById("donIdForExtension").value; // 수정된 부분
    console.log("새로운 기한:", newDeadlineValue, "donId:", donIdVal);
    
     //let donIdVal =  document.getElementById("did").value;
     //$('#did').val();
    // console.log(donIdVal);
 		
     let donaVO = {
    		 donId : donIdVal,
    		 extPeriod : newDeadlineValue
     }
     
     console.log(donaVO);
    	
        $.ajax({
        	type: 'PUT',
            url: '/facilityMyPage/donaInfo/extension',
            //dataType : 'json',   
            data: JSON.stringify(donaVO),
        	contentType : 'application/json', 
            
            success: function(response) {
              
            	   // 기존 모달 닫기
                $("#extendDeadlineModal").modal("hide");

                // 새로운 모달 열기
                openSuccessModal();
                return;
            },
            error: function(error) {
            	console.log("아작스실패");
                console.error(error);
            }
        })
    	
    	
    	
    // 모달 닫기
    $("#extendDeadlineModal").modal("hide");
}

//성공 메시지 모달 열기
function openSuccessModal() {
    $("#successModal").modal("show");

    // 모달이 닫힐 때 이벤트 리스너 등록
    $("#successModal").on("hidden.bs.modal", function () {
        // 모달 닫힌 후 실행할 동작
        
        location.reload(); // 새로고침
    });
}

// 리뷰창
function openReviewForm(button) {
	// 후기글이 존재하면 이미 후기글이 존재한다고 경고창 띄우기
	var revStat = button.getAttribute("data-hasrev");
	nsole.log("revStat:", revStat); // 콘솔에 revStat 출력

	if(revStat === '1'){
		alert("이미 후기글이 존재합니다.");
		return;
	}else{
		
    var donId = button.getAttribute("data-donId");
    var facId = button.getAttribute("data-facId");
    // donId와 facId를 이용하여 후기 작성 페이지로 이동
    var reviewUrl = '/reviewform?donId=' + donId + '&facId=' + facId;
    window.location.href = reviewUrl;
	}
}


//영수증
function openReceiptModal(button) {
	console.log("영수증")
    var donId = button.getAttribute("data-donId");
    console.log("여donId", donId);
    var facId = button.getAttribute("data-facId");
    console.log("여donId", facId);

    // donId와 facId를 모달에 저장
    document.getElementById("donIdForReceipt").value = donId;
    document.getElementById("facIdForReceipt").value = facId;

    // 모달 열기
    $("#receiptModal").modal("show");
}

function submitReceipt() {
    // 선택된 파일과 donId, facId 가져오기
    let receiptFile = document.getElementById("uploadFiles").files[0];
    console.log('파일컴온', receiptFile);
    let donId = document.getElementById("donIdForReceipt").value;
    let facId = document.getElementById("facIdForReceipt").value;
	
    // FormData를 사용하여 파일 및 추가 정보 전송
    let formData = new FormData();
    //formData.append("donId", donId);
    //formData.append("facId", facId);
    
    formData.append("uploadFiles", receiptFile);
	//formData.append("memId", facId);
	
	formData.append("codeUser", facId);
    formData.append('codeNo', donId);
    formData.append("code", "p06")
	
 // 첫 번째 AJAX 요청
	$.ajax({
		type : 'POST',
		url : '/uploadsAjax',
		data : formData,
		processData: false,
		contentType: false,
		success: function(response) {
			console.log("첫 번째 AJAX 성공: " + response);
			
			// 두 번째 AJAX 요청
			$.ajax({
				type: 'POST',
				 url: '/receiptAlert',
				data: {memId : facId},
				
				success: function (applyResponse) {
					console.log("두 번째 AJAX 성공: " + applyResponse);
					alert("두번째 등록 성공!");
					// 성공 메시지 모달 열기
                    $("#successModal").modal("show");

                    // 성공 메시지 모달이 닫힐 때 이벤트 리스너 등록
                    $("#successModal").on("hidden.bs.modal", function () {
                        location.href = "donaInfo"; // 새로고침 또는 다른 동작 수행
                    });
				},
				error: function (applyError) {
					console.error("두 번째 AJAX 실패: " + applyError);
				}
			});
		},
		error: function(error) {
			console.error("첫 번째 AJAX 실패: " + error);
		}
	});
}

</script>
</div>
	</section>
</body>
</html>