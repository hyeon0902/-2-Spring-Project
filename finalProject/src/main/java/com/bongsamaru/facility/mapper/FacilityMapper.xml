<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 
<mapper namespace="com.bongsamaru.facility.mapper.FacilityMapper">
<!-- 시설리스트 -->
<select id="getFacilityList" resultType="FacilityVO">
	SELECT FAC_NAME,
	SUBSTR(FAC_ADDR,1,INSTR(FAC_ADDR, ' ')-1) AS region,
	FAC_TYPE
	FROM FACILITY
</select>
<select id="getFacilityInfo" resultType="FacilityVO">
 Select Fac_Name,
 		Fac_Type, 
 		Fac_Addr,
 		Fac_Web,
		(Select Sum(T1.Don_Amt) From Don_Ledger T1 Left Join Donation T2 On T1.Don_Id= T2.Don_Id Where T2.Fac_Id=#{facId}) As donaitonAmt,
		(Select Count(Distinct(T1.Mem_Id)) From Don_Ledger T1 Left Join Donation T2 On T1.Don_Id= T2.Don_Id Where T2.Fac_Id=#{facId}) As donors
		From Facility Where Fac_Id=#{facId}
</select>
<!-- 시설에서 진행중인 모금정보 List-->
<select id="getfundingList" resultType="FundingVO">
	SELECT D1.DON_ID,D1.TITLE AS title, 
	D1.GOAL_AMT AS goalAmt, 
	D1.REC_STAT AS state,
	SUM(NVL(0,D2.DON_AMT)) AS donationAmt, 
	COUNT(DISTINCT (D2.MEM_ID)) AS donors, 
	D1.DON_ID AS donId
	FROM DONATION D1 LEFT JOIN DON_LEDGER D2 ON D1.DON_ID=D2.DON_ID
	WHERE D1.REC_STAT ='0' AND D1.DON_REG_APP='1'
	GROUP BY D1.DON_ID,D1.TITLE, D1.GOAL_AMT, D1.REC_STAT
</select>

<!-- 시설에서 진행마감인 모금정보 List-->
<select id="getfundedList" resultType="FundingVO">
	SELECT D1.DON_ID,D1.TITLE AS title, 
	D1.GOAL_AMT AS goalAmt, 
	D1.REC_STAT AS state,
	SUM(NVL(0,D2.DON_AMT)) AS donationAmt, 
	COUNT(DISTINCT (D2.MEM_ID)) AS donors, 
	D1.DON_ID AS donId
	FROM DONATION D1 LEFT JOIN DON_LEDGER D2 ON D1.DON_ID=D2.DON_ID
	WHERE D1.REC_STAT ='1' AND D1.DON_REG_APP='1'
	GROUP BY D1.DON_ID,D1.TITLE, D1.GOAL_AMT, D1.REC_STAT
</select>
</mapper>



